# E2Eテストガイド - Gmail → LINE通知

実際にメールを送信して、LINE通知が届くかテストする手順です。

## 📋 テスト手順

### ステップ1: テスト用メールを送信

自分宛に、以下のような内容のメールを送信してください。

#### ✅ Type A（要返信）の例

```
件名: 【緊急】本日の会議について

お世話になっております。

本日の会議が急遽変更になりました。
15時から開始となります。

ご確認をお願いします。
```

**期待される動作:**
- AIがType Aと判定
- 返信ドラフトが自動生成される
- LINEにFlex Message（Type A）が送信される
- 「送信」「修正」「断る」ボタンが表示される

#### ✅ Type B（確認必要）の例

```
件名: 資料の確認依頼

お世話になっております。

先日お送りした資料について、
ご確認いただけますでしょうか。

ご質問があればお知らせください。
```

**期待される動作:**
- AIがType Bと判定
- LINEにFlex Message（Type B）が送信される
- 「既読」「確認メール」ボタンが表示される

#### ❌ Type C（低優先度）の例（通知されません）

```
件名: ニュースレター配信のお知らせ

今月のニュースレターを配信いたしました。
ぜひご覧ください。
```

**期待される動作:**
- AIがType Cと判定
- LINE通知は送信されない（ログのみ）

---

### ステップ2: Gmailポーリングを実行

メール送信後、以下のコマンドを実行してください：

```bash
cd /Users/nishiyamaakihiro/Desktop/safereply-node
npm run test-gmail-polling
```

**実行結果の確認ポイント:**

1. **メッセージが取得されたか**
   ```
   取得したメッセージ数: X
   ```

2. **新規メッセージが処理されたか**
   ```
   新規メッセージ数: X
   ```

3. **トリアージ結果**
   - Type A/Bの場合: LINE通知が送信される
   - Type Cの場合: 通知スキップ（ログに表示）

4. **エラーがないか**
   ```
   エラー: (空欄が正常)
   ```

---

### ステップ3: LINEアプリで通知を確認

1. LINEアプリを開く
2. SafeReply Botのトーク画面を確認
3. 通知が届いているか確認

**Type Aの場合:**
- 「【要返信】返信が必要なメッセージが届きました」というFlex Message
- 返信案が表示される
- 「送信」「修正」「断る」ボタンが表示される

**Type Bの場合:**
- 「【メッセージ受信】共有・CCメッセージが届きました」というFlex Message
- 「既読」「確認メール」ボタンが表示される

---

## 🔍 トラブルシューティング

### 問題1: メッセージが取得されない

**確認事項:**
- メールが過去3日以内に送信されているか
- メールが迷惑メールフォルダに入っていないか
- Gmail APIのリフレッシュトークンが有効か

**解決方法:**
```bash
# Gmail APIの動作確認
npm run test-gmail-api
```

### 問題2: メッセージは取得されたが、LINE通知が届かない

**確認事項:**
- トリアージ結果がType AまたはBか（Type Cは通知されません）
- LINE_CHANNEL_ACCESS_TOKENが正しく設定されているか
- LINE_ALLOWED_USER_IDSに自分のLINE User IDが含まれているか

**解決方法:**
```bash
# LINE通知の動作確認
npm run test-line-notification
```

### 問題3: Type Cと判定されて通知されない

**原因:**
- メール内容が低優先度と判定された

**解決方法:**
- より重要な内容のメールを送信する
- 件名に「【緊急】」「【重要】」などを含める
- 明確な返信依頼や確認依頼を含める

---

## 📊 テスト結果の記録

テスト実行後、以下の情報を記録してください：

- **送信したメールの件名**
- **トリアージ結果（Type A/B/C）**
- **LINE通知が届いたか（Yes/No）**
- **通知の内容（Flex Messageの種類）**
- **エラーがあった場合の内容**

---

## 💡 ヒント

- **初回テスト**: Type Aのメールを送信すると、返信ドラフトも確認できます
- **複数メール**: 複数のメールを送信して、それぞれの処理結果を確認できます
- **処理済みメール**: 同じメールは2回目以降はスキップされます（Redisで管理）

---

**最終更新**: 2025-12-04





