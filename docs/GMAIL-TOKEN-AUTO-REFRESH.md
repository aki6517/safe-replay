# Gmail APIトークン自動更新ガイド

## 概要

Gmail APIのリフレッシュトークンが失効した場合、手動で更新する必要がなくなるよう、自動検出とLINE通知機能を実装しました。

## 実装内容

### 1. トークン失効の自動検出

Gmail API呼び出し時にエラーが発生した場合、以下のエラーパターンを検出します：

- `invalid_grant`
- `Token has been expired`
- `Token has been revoked`
- `invalid_token`
- `unauthorized_client`
- `access_denied`

### 2. LINE緊急通知

トークン失効が検出されると、自動的にLINE緊急通知が送信されます：

- **通知タイトル**: `Gmail APIトークン失効`
- **通知内容**: エラー詳細と対処方法
- **重複防止**: 1時間以内の重複通知は自動的にスキップされます

### 3. 定期的なトークン使用（6ヶ月失効防止）

リフレッシュトークンは6ヶ月間使用されないと自動的に失効します。これを防ぐため、以下の仕組みを実装しました：

#### 手動実行

```bash
npm run verify-gmail-token
```

#### GitHub Actions自動実行

`.github/workflows/verify-gmail-token.yml`が設定されており、**毎週月曜日の午前9時（JST）**に自動実行されます。

## 使用方法

### 通常の運用

通常の運用では、特別な操作は不要です：

1. **アクセストークンの自動リフレッシュ**: `googleapis`ライブラリが自動的にアクセストークンをリフレッシュします
2. **リフレッシュトークン失効の検出**: エラー発生時に自動検出され、LINE通知が送信されます
3. **定期的なトークン使用**: GitHub Actionsが自動的に実行されます

### リフレッシュトークンが失効した場合

**自動検出と通知**:
1. トークン失効が自動検出され、LINE通知が届きます
2. 通知には再認証用のURLと手順が含まれています

**手動での再認証**（通知に従って実行）:
1. LINE通知に表示された認証URLをブラウザで開く（または通知の「詳細を確認」ボタンをタップ）
2. Googleアカウントで認証する
3. 認証後に表示されたコードをコピーする
4. ターミナルで以下のコマンドを実行：
   ```bash
   npm run get-gmail-refresh-token
   ```
5. 表示されたコードを貼り付けてEnterキーを押す
6. 新しいリフレッシュトークンが表示されるので、`.env`ファイルまたは環境変数に`GMAIL_REFRESH_TOKEN`を更新する
7. アプリケーションを再起動する（必要に応じて）

**注意**: リフレッシュトークンの再発行には、セキュリティ上の理由からブラウザでの認証が必要です。完全自動化はできませんが、通知に手順が含まれているため、簡単に再認証できます。

## GitHub Actions設定

GitHub Actionsを使用する場合は、以下のシークレットを設定してください：

- `GMAIL_CLIENT_ID`
- `GMAIL_CLIENT_SECRET`
- `GMAIL_REFRESH_TOKEN`
- `LINE_CHANNEL_ACCESS_TOKEN`
- `LINE_ALLOWED_USER_IDS`

## 注意事項

### リフレッシュトークンが失効する主な原因

1. **6ヶ月間未使用**: リフレッシュトークンが6ヶ月間使用されないと失効します
   - **対策**: GitHub Actionsの定期実行により、毎週トークンを使用します

2. **ユーザーがアクセスを取り消した**: Googleアカウントの設定でアプリのアクセスを取り消した場合
   - **対策**: 再認証が必要です

3. **パスワード変更**: Googleアカウントのパスワードを変更した場合
   - **対策**: 再認証が必要です

4. **セキュリティ上の理由**: Googleがセキュリティ上の理由でトークンを無効化した場合
   - **対策**: 再認証が必要です

### 再認証が必要な場合

以下のコマンドで新しいリフレッシュトークンを取得できます：

```bash
npm run get-gmail-refresh-token
```

詳細は`docs/GMAIL-API-SETUP.md`を参照してください。

## トラブルシューティング

### LINE通知が届かない

1. `LINE_CHANNEL_ACCESS_TOKEN`が正しく設定されているか確認
2. `LINE_ALLOWED_USER_IDS`に自分のLINE User IDが含まれているか確認
3. ログを確認してエラーがないか確認

### GitHub Actionsが実行されない

1. GitHubリポジトリの設定でActionsが有効になっているか確認
2. シークレットが正しく設定されているか確認
3. ワークフローファイルの構文エラーがないか確認

## 関連ドキュメント

- `docs/GMAIL-API-SETUP.md`: Gmail APIの初期設定
- `docs/GMAIL-OAUTH-TROUBLESHOOTING.md`: OAuth認証のトラブルシューティング


