# Gmail API OAuth設定 トラブルシューティング

## ⚠️ 重要：リフレッシュトークンが7日で失効する問題

### 問題

GCPプロジェクトのOAuth同意画面が「**テスト**」モードの場合、リフレッシュトークンは**7日間で失効**します。

### 解決方法：OAuth同意画面を「本番」モードに変更

1. **Google Cloud Console**にアクセス
2. 「**APIとサービス**」→「**OAuth同意画面**」をクリック
3. 「**公開ステータス**」セクションを確認
   - 「テスト」と表示されている場合は、「**アプリを公開**」ボタンをクリック
4. 確認ダイアログが表示されたら「**確認**」をクリック

### 注意点

- **本番モードに変更しても、アプリは一般公開されません**（内部使用のみ）
- 本番モードでは、リフレッシュトークンは長期間有効になります（使用されている限り無期限）
- Googleの審査は**不要**です（機密性の低いスコープのみ使用している場合）

### トークンの有効期限

| モード | アクセストークン | リフレッシュトークン |
|--------|------------------|----------------------|
| テスト | 1時間 | **7日間** |
| 本番 | 1時間 | 長期間（無期限*） |

*使用されない場合は6ヶ月で失効

---

## ❌ よくあるエラーと解決方法

### エラー: "invalid_grant" - Token has been expired or revoked

**症状**: Gmail API呼び出し時に「invalid_grant」エラーが発生する

**原因**: 以下のいずれか
1. OAuth同意画面が「テスト」モードで、リフレッシュトークンが7日で失効した
2. ユーザーがGoogleアカウントでアクセス権を取り消した
3. 6ヶ月間使用されなかった
4. パスワードを変更した

**解決方法**:
1. **OAuth同意画面を「本番」モードに変更**（上記参照）
2. 新しいリフレッシュトークンを取得: `npm run get-gmail-refresh-token`
3. `.env`ファイルを更新

### エラー: "redirect_uri_mismatch"

**症状**: OAuth認証時に「エラー 400: redirect_uri_mismatch」が表示される

**原因**: OAuth 2.0クライアントIDの設定で、リダイレクトURIが正しく設定されていない

**解決方法**:

1. **正しい場所を確認**
   - ❌ 「承認済みドメイン」セクション → これは間違った場所です
   - ✅ 「承認済みのリダイレクトURI」セクション → こちらが正しい場所です

2. **OAuth 2.0クライアントIDの編集画面を開く**
   - Google Cloud Console → 「APIとサービス」→「認証情報」
   - 作成したOAuth 2.0クライアントIDの**編集アイコン（鉛筆マーク）**をクリック

3. **「承認済みのリダイレクトURI」セクションを探す**
   - 画面を下にスクロールして「承認済みのリダイレクトURI」セクションを見つける
   - 「承認済みドメイン」とは別のセクションです

4. **リダイレクトURIを追加**
   - 「URIを追加」ボタンをクリック
   - 使用する方法に応じて、以下のいずれかを入力：
     - **デスクトップアプリ（スクリプト使用）**: `urn:ietf:wg:oauth:2.0:oob`
     - **OAuth 2.0 Playground使用**: `https://developers.google.com/oauthplayground`
   - **重要**: `https://`を含む完全なURLを入力してください

5. **保存**
   - 「保存」ボタンをクリック
   - 変更が反映されるまで数秒待つ

### エラー: "無効なドメイン: スキーム (http:// または https://) を指定することはできません"

**症状**: 「承認済みドメイン」セクションにURLを入力しようとしてエラーが表示される

**原因**: 「承認済みドメイン」と「承認済みのリダイレクトURI」を混同している

**解決方法**:
- 「承認済みドメイン」セクションは使用しません
- OAuth 2.0クライアントIDの編集画面で「承認済みのリダイレクトURI」セクションを使用してください

### エラー: "無効なドメイン: 最上位のプライベート ドメインを指定する必要があります"

**症状**: 「承認済みドメイン」セクションにパス付きURLを入力しようとしてエラーが表示される

**原因**: 「承認済みドメイン」はドメイン名のみ（例: `example.com`）を入力する場所で、リダイレクトURIではありません

**解決方法**:
- 「承認済みドメイン」セクションは使用しません
- OAuth 2.0クライアントIDの編集画面で「承認済みのリダイレクトURI」セクションを使用してください

## 📍 正しい設定場所の見つけ方

1. Google Cloud Consoleにログイン
2. 「APIとサービス」→「認証情報」をクリック
3. OAuth 2.0クライアントIDの一覧が表示される
4. 編集したいクライアントIDの右側にある**編集アイコン（鉛筆マーク）**をクリック
5. 編集画面が開く
6. 画面を下にスクロールして「承認済みのリダイレクトURI」セクションを見つける
   - 「承認済みドメイン」とは別のセクションです
   - 「承認済みのリダイレクトURI」というタイトルが表示されています

## ✅ 設定例

### デスクトップアプリ（スクリプト使用）の場合

```
承認済みのリダイレクトURI:
- urn:ietf:wg:oauth:2.0:oob
```

### OAuth 2.0 Playgroundを使用する場合

```
承認済みのリダイレクトURI:
- https://developers.google.com/oauthplayground
```

### 両方を使用する場合

```
承認済みのリダイレクトURI:
- urn:ietf:wg:oauth:2.0:oob
- https://developers.google.com/oauthplayground
```

## 🔍 確認方法

設定が正しく反映されているか確認する方法：

1. OAuth 2.0クライアントIDの編集画面を開く
2. 「承認済みのリダイレクトURI」セクションを確認
3. 追加したURIが表示されていることを確認
4. 保存ボタンをクリックして変更を保存

## 💡 推奨方法

**デスクトップアプリ（スクリプト使用）を推奨**します：

1. リダイレクトURI: `urn:ietf:wg:oauth:2.0:oob` を追加
2. `npm run get-gmail-refresh-token` を実行
3. 表示されたURLをブラウザで開く
4. 認証コードを入力
5. リフレッシュトークンを取得

この方法の方が簡単で、OAuth 2.0 Playgroundの設定は不要です。


