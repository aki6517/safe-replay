# Gmail API OAuth設定 トラブルシューティング

## ❌ よくあるエラーと解決方法

### エラー: "redirect_uri_mismatch"

**症状**: OAuth認証時に「エラー 400: redirect_uri_mismatch」が表示される

**原因**: OAuth 2.0クライアントIDの設定で、リダイレクトURIが正しく設定されていない

**解決方法**:

1. **正しい場所を確認**
   - ❌ 「承認済みドメイン」セクション → これは間違った場所です
   - ✅ 「承認済みのリダイレクトURI」セクション → こちらが正しい場所です

2. **OAuth 2.0クライアントIDの編集画面を開く**
   - Google Cloud Console → 「APIとサービス」→「認証情報」
   - 作成したOAuth 2.0クライアントIDの**編集アイコン（鉛筆マーク）**をクリック

3. **「承認済みのリダイレクトURI」セクションを探す**
   - 画面を下にスクロールして「承認済みのリダイレクトURI」セクションを見つける
   - 「承認済みドメイン」とは別のセクションです

4. **リダイレクトURIを追加**
   - 「URIを追加」ボタンをクリック
   - 使用する方法に応じて、以下のいずれかを入力：
     - **デスクトップアプリ（スクリプト使用）**: `urn:ietf:wg:oauth:2.0:oob`
     - **OAuth 2.0 Playground使用**: `https://developers.google.com/oauthplayground`
   - **重要**: `https://`を含む完全なURLを入力してください

5. **保存**
   - 「保存」ボタンをクリック
   - 変更が反映されるまで数秒待つ

### エラー: "無効なドメイン: スキーム (http:// または https://) を指定することはできません"

**症状**: 「承認済みドメイン」セクションにURLを入力しようとしてエラーが表示される

**原因**: 「承認済みドメイン」と「承認済みのリダイレクトURI」を混同している

**解決方法**:
- 「承認済みドメイン」セクションは使用しません
- OAuth 2.0クライアントIDの編集画面で「承認済みのリダイレクトURI」セクションを使用してください

### エラー: "無効なドメイン: 最上位のプライベート ドメインを指定する必要があります"

**症状**: 「承認済みドメイン」セクションにパス付きURLを入力しようとしてエラーが表示される

**原因**: 「承認済みドメイン」はドメイン名のみ（例: `example.com`）を入力する場所で、リダイレクトURIではありません

**解決方法**:
- 「承認済みドメイン」セクションは使用しません
- OAuth 2.0クライアントIDの編集画面で「承認済みのリダイレクトURI」セクションを使用してください

## 📍 正しい設定場所の見つけ方

1. Google Cloud Consoleにログイン
2. 「APIとサービス」→「認証情報」をクリック
3. OAuth 2.0クライアントIDの一覧が表示される
4. 編集したいクライアントIDの右側にある**編集アイコン（鉛筆マーク）**をクリック
5. 編集画面が開く
6. 画面を下にスクロールして「承認済みのリダイレクトURI」セクションを見つける
   - 「承認済みドメイン」とは別のセクションです
   - 「承認済みのリダイレクトURI」というタイトルが表示されています

## ✅ 設定例

### デスクトップアプリ（スクリプト使用）の場合

```
承認済みのリダイレクトURI:
- urn:ietf:wg:oauth:2.0:oob
```

### OAuth 2.0 Playgroundを使用する場合

```
承認済みのリダイレクトURI:
- https://developers.google.com/oauthplayground
```

### 両方を使用する場合

```
承認済みのリダイレクトURI:
- urn:ietf:wg:oauth:2.0:oob
- https://developers.google.com/oauthplayground
```

## 🔍 確認方法

設定が正しく反映されているか確認する方法：

1. OAuth 2.0クライアントIDの編集画面を開く
2. 「承認済みのリダイレクトURI」セクションを確認
3. 追加したURIが表示されていることを確認
4. 保存ボタンをクリックして変更を保存

## 💡 推奨方法

**デスクトップアプリ（スクリプト使用）を推奨**します：

1. リダイレクトURI: `urn:ietf:wg:oauth:2.0:oob` を追加
2. `npm run get-gmail-refresh-token` を実行
3. 表示されたURLをブラウザで開く
4. 認証コードを入力
5. リフレッシュトークンを取得

この方法の方が簡単で、OAuth 2.0 Playgroundの設定は不要です。

